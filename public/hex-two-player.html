<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2 Player</title>
    <link rel="stylesheet" href = "styles/hex-two-player.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class = grid-header> 
        <button class = "header" id = "home" onclick="window.location.href='./index.html';">
            <p> HOME </p>
        </button>

        <button class = "header" id="start-button">
            <p> RESTART </p>
        </button>
    </div> 
    
    <div class = "spacing"> </div>
    <div class="grid" id = "grid">
            <p id="user-container"> You: <span id="user"></span> </p>
            <p id="opponent-container"> Opponent: <span id="opponent"></span> </p>
            <p id="color-assignment"> You are: <span id="color"></span></p>
            <p id="turn"><span id="curr"></span>'s Move</p>

            <p id="entername">Enter your Name: </p>
            <input type="text" placeholder="Name" id="name" autocomplete="off">
            <button id="searchPlayer">Search for another player</button>
    </div>

</body>

<script>var exports = {};</script>
<script type="module" src = scripts/utility.js></script>

<script src="/socket.io/socket.io.js"></script>
<script type="module">

    import Board from "./scripts/Board.js";
    import Game from "./scripts/Game.js"
    import {changeColor, checkWin} from "./scripts/helper.js"

    const socket = io();
    var board = new Board(socket);
    var game = new Game(board);


    var start_button = document.getElementById("start-button");
    grid?.addEventListener("click", buttonHandler, false);
    start_button?.addEventListener("click", startHandler, false);

    function buttonHandler(evt){
        if (evt.target != null && evt.target instanceof Element){
            let test_arr = (evt.target.id).split('_');

            let r  = test_arr[0];
            let r_coord  = parseInt(test_arr[1]);
            let c = test_arr[2];
            let c_coord  = parseInt(test_arr[3]);

            //RECONSTRUCT hex_id
            let newColor = (game.curr_player == "red") ? "red" : "blue";

            if (r === 'r' && c === 'c' && (newColor == curr_player)){
                changeColor(r_coord, c_coord, color, board.tile_array);

                socket.emit("colorChange", {row: r_coord, col: c_coord, color:color})
                
                document.getElementById("curr").innerText= (game.curr_plauer == "red") ? "Blue" : "Red";

                let win = checkWin(color, board.tile_array, board.g);

                if (win){
                    if (color == "red"){
                        window.alert("Red has won!")
                        console.log("Red has won! Press the restart button to play again!")
                    }
                    else{
                        window.alert("Blue has won!")
                        console.log("Blue has won! Press the restart button to play again!")
                    }
                }  

                game.curr_player = (game.curr_player == "red") ? "blue" : "red";
                game.turn += 1;
            }
            evt.stopPropagation();
        }
    }

    function startHandler(evt){
        document.getElementById("curr").innerText="Red";

        let r = 2;
        while (r <= 12){
            let c = 2;
            while (c <= 12){
                let hex_container_id = 'r_' + r + '_c_' + c;
                let hex_container = document.querySelector("#" + hex_container_id);
                if (hex_container?.className == "true"){
                    hex_container.className = "false";

                    let hex_upper = document.getElementById(hex_container_id + "_upper");
                    let hex_middle = document.getElementById(hex_container_id + "_middle");
                    let hex_lower = document.getElementById(hex_container_id + "_lower");  

                    if (hex_upper != null){
                        hex_upper.style.borderBottomColor = "#6C8";
                    }
                    //middle
                    if (hex_middle != null){
                        hex_middle.style.background = "#6C8";
                    }
                    //bottom
                    if (hex_lower != null){
                        hex_lower.style.borderTopColor = "#6C8";
                    }
                }
                c += 1;
            }
            r += 1;
        }
        let i = 0;
        while (i < 11){
            let k = 0;
            while (k < 11){
                board.tile_array[i][k].set_color("#6C8");
                k += 1;
            }
            i += 1;
        }
    }

    /* SIDEBAR SETUP*/

    let name;
    document.getElementById("curr").innerText="Red";
    document.getElementById("searchPlayer").addEventListener("click", function(){
        name=document.getElementById("name").value;

        document.getElementById("user").innerText=name;
        if(name==null || name==''){
            alert("Enter a name")
        }
        else{ 
            socket.emit("find", {name:name})
        }
    })

    socket.on("find", (e)=>{
        let gameArr = e.game

        let opponent
        let color

        const thisGame=gameArr.find(obj=>obj.p1.name ==`${name}` || obj.p2.name == `${name}`)
        
        thisGame.p1.name == `${name}` ? opponent=thisGame.p2.name : opponent=thisGame.p1.name
        thisGame.p1.name == `${name}` ? color=thisGame.p1.color : color=thisGame.p2.color

        document.getElementById("opponent").innerText=opponent
        document.getElementById("color").innerText=color
    })

    socket.on("colorChange", (e) => {
        let row = e.row
        let col = e.col;
        let newColor = e.color;
        
        if (newColor == "red"){
            document.getElementById("curr").innerText="Red";
        }
        else{
            document.getElementById("curr").innerText="Blue";
        }
        
        changeColor(row, col, newColor, board.tile_array)
    })


</script>